/**
 * PhysicsJS v0.5.3 - 2013-11-25
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2013 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */
!function(a,b){"object"==typeof exports?module.exports=b.call(a):"function"==typeof define&&define.amd?define(function(){return b.call(a)}):a.Physics=b.call(a)}(this,function(){"use strict";var a=function c(){return c.world.apply(c,arguments)};a.util={},!function(b){function c(a){return"function"!=typeof a.toString&&"string"==typeof(a+"")}function d(){}function e(a){a.length=0,z.length<C&&z.push(a)}function f(a,b,c){b||(b=0),"undefined"==typeof c&&(c=a?a.length:0);var d=-1;c=c-b||0;for(var e=Array(0>c?0:c);++d<c;)e[d]=a[b+d];return e}function g(){}function h(a,b,d,g,i){if(d){var j=d(a);if("undefined"!=typeof j)return j}if(!r(a))return a;var k=gb.call(a);if(!Q[k]||!ub.nodeClass&&c(a))return a;var l=sb[k];switch(k){case J:case K:return new l(+a);case M:case P:return new l(a);case O:return j=l(a.source,D.exec(a)),j.lastIndex=a.lastIndex,j}if(k=wb(a),b){var m=!g;g||(g=z.pop()||[]),i||(i=z.pop()||[]);for(var n=g.length;n--;)if(g[n]==a)return i[n];j=k?l(a.length):{}}else j=k?f(a):Bb({},a);return k&&(cb.call(a,"index")&&(j.index=a.index),cb.call(a,"input")&&(j.input=a.input)),b?(g.push(a),i.push(j),(k?Ab:Db)(a,function(a,c){j[c]=h(a,b,d,g,i)}),m&&(e(g),e(i)),j):j}function i(a,b,c){if("function"!=typeof a)return w;if("undefined"==typeof b)return a;var d=a.__bindData__||ub.funcNames&&!a.name;if("undefined"==typeof d){var e=F&&ab.call(a);ub.funcNames||!e||E.test(e)||(d=!0),(ub.funcNames||!d)&&(d=!ub.funcDecomp||F.test(e),vb(a,d))}if(!0!==d&&d&&1&d[1])return a;switch(c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,e){return a.call(b,c,d,e)};case 4:return function(c,d,e,f){return a.call(b,c,d,e,f)}}return u(a,b)}function j(a,b,d,f,g,h){if(d){var i=d(a,b);if("undefined"!=typeof i)return!!i}if(a===b)return 0!==a||1/a==1/b;if(a===a&&!(a&&U[typeof a]||b&&U[typeof b]))return!1;if(null==a||null==b)return a===b;var k=gb.call(a),l=gb.call(b);if(k==H&&(k=N),l==H&&(l=N),k!=l)return!1;switch(k){case J:case K:return+a==+b;case M:return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case O:case P:return a==b+""}if(l=k==I,!l){if(cb.call(a,"__wrapped__")||cb.call(b,"__wrapped__"))return j(a.__wrapped__||a,b.__wrapped__||b,d,f,g,h);if(k!=N||!ub.nodeClass&&(c(a)||c(b)))return!1;var k=!ub.argsObject&&p(a)?Object:a.constructor,m=!ub.argsObject&&p(b)?Object:b.constructor;if(k!=m&&!(q(k)&&k instanceof k&&q(m)&&m instanceof m))return!1}for(m=!g,g||(g=z.pop()||[]),h||(h=z.pop()||[]),k=g.length;k--;)if(g[k]==a)return h[k]==b;var n=0,i=!0;if(g.push(a),h.push(b),l){if(k=a.length,n=b.length,i=n==a.length,!i&&!f)return i;for(;n--;)if(l=k,m=b[n],f)for(;l--&&!(i=j(a[l],m,d,f,g,h)););else if(!(i=j(a[n],m,d,f,g,h)))break;return i}return Cb(b,function(b,c,e){return cb.call(e,c)?(n++,i=cb.call(a,c)&&j(a[c],b,d,f,g,h)):void 0}),i&&!f&&Cb(a,function(a,b,c){return cb.call(c,b)?i=-1<--n:void 0}),m&&(e(g),e(h)),i}function l(a,b,c,d,e,f){var g=1&b,h=2&b,i=4&b,j=8&b,k=16&b,m=32&b,o=a;if(!h&&!q(a))throw new TypeError;k&&!c.length&&(b&=-17,k=c=!1),m&&!d.length&&(b&=-33,m=d=!1);var p=a&&a.__bindData__;if(p)return!g||1&p[1]||(p[4]=e),!g&&1&p[1]&&(b|=8),!i||4&p[1]||(p[5]=f),k&&eb.apply(p[2]||(p[2]=[]),c),m&&eb.apply(p[3]||(p[3]=[]),d),p[1]|=b,l.apply(null,p);if(!g||h||i||m||!(ub.fastBind||jb&&k))t=function(){var p=arguments,q=g?e:this;return(i||k||m)&&(p=qb.call(p),k&&hb.apply(p,c),m&&eb.apply(p,d),i&&p.length<f)?(b|=16,l(a,j?b:-4&b,p,null,e,f)):(h&&(a=q[o]),this instanceof t?(q=n(a.prototype),p=a.apply(q,p),r(p)?p:q):a.apply(q,p))};else{if(k){var s=[e];eb.apply(s,c)}var t=k?jb.apply(a,s):jb.call(a,e)}return vb(t,qb.call(arguments)),t}function m(){T.h=G,T.b=T.c=T.g=T.i="",T.e="t",T.j=!0;for(var a,b=0;a=arguments[b];b++)for(var c in a)T[c]=a[c];b=T.a,T.d=/^[^,]+/.exec(b)[0],a=Function,b="return function("+b+"){",c=T;var d="var n,t="+c.d+",E="+c.e+";if(!t)return E;"+c.i+";";c.b?(d+="var u=t.length;n=-1;if("+c.b+"){",ub.unindexedChars&&(d+="if(s(t)){t=t.split('')}"),d+="while(++n<u){"+c.g+";}}else{"):ub.nonEnumArgs&&(d+="var u=t.length;n=-1;if(u&&p(t)){while(++n<u){n+='';"+c.g+";}}else{"),ub.enumPrototypes&&(d+="var G=typeof t=='function';"),ub.enumErrorProps&&(d+="var F=t===k||t instanceof Error;");var e=[];if(ub.enumPrototypes&&e.push('!(G&&n=="prototype")'),ub.enumErrorProps&&e.push('!(F&&(n=="message"||n=="name"))'),c.j&&c.f)d+="var C=-1,D=B[typeof t]&&v(t),u=D?D.length:0;while(++C<u){n=D[C];",e.length&&(d+="if("+e.join("&&")+"){"),d+=c.g+";",e.length&&(d+="}"),d+="}";else if(d+="for(n in t){",c.j&&e.push("m.call(t, n)"),e.length&&(d+="if("+e.join("&&")+"){"),d+=c.g+";",e.length&&(d+="}"),d+="}",ub.nonEnumShadows){for(d+="if(t!==A){var i=t.constructor,r=t===(i&&i.prototype),f=t===J?I:t===k?j:L.call(t),x=y[f];",k=0;7>k;k++)d+="n='"+c.h[k]+"';if((!(r&&x[n])&&m.call(t,n))",c.j||(d+="||(!x[n]&&t[n]!==A[n])"),d+="){"+c.g+"}";d+="}"}return(c.b||ub.nonEnumArgs)&&(d+="}"),d+=c.c+";return E",a("d,j,k,m,o,p,q,s,v,A,B,y,I,J,L",b+d+"}")(i,L,X,cb,B,p,wb,s,T.f,Y,U,tb,P,Z,gb)}function n(a){return r(a)?kb(a):{}}function o(a){var b,d;return!a||gb.call(a)!=N||(b=a.constructor,q(b)&&!(b instanceof b))||!ub.argsClass&&p(a)||!ub.nodeClass&&c(a)?!1:ub.ownLast?(Cb(a,function(a,b,c){return d=cb.call(c,b),!1}),!1!==d):(Cb(a,function(a,b){d=b}),"undefined"==typeof d||cb.call(a,d))}function p(a){return a&&"object"==typeof a&&"number"==typeof a.length&&gb.call(a)==H||!1}function q(a){return"function"==typeof a}function r(a){return!(!a||!U[typeof a])}function s(a){return"string"==typeof a||gb.call(a)==P}function t(a,b,c){if(b&&"undefined"==typeof c&&wb(a)){c=-1;for(var d=a.length;++c<d&&!1!==b(a[c],c,a););}else Ab(a,b,c);return a}function u(a,b){return 2<arguments.length?l(a,17,qb.call(arguments,2),null,b):l(a,1,null,null,b)}function v(a,b,c){var d,e,f,g,h,i,j,k=0,l=!1,m=!0;if(!q(a))throw new TypeError;if(b=nb(0,b)||0,!0===c)var n=!0,m=!1;else r(c)&&(n=c.leading,l="maxWait"in c&&(nb(b,c.maxWait)||0),m="trailing"in c?c.trailing:m);var o=function(){var c=b-(db()-g);c>0?i=setTimeout(o,c):(e&&clearTimeout(e),c=j,e=i=j=y,c&&(k=db(),f=a.apply(h,d)))},p=function(){i&&clearTimeout(i),e=i=j=y,(m||l!==b)&&(k=db(),f=a.apply(h,d))};return function(){if(d=arguments,g=db(),h=this,j=m&&(i||!n),!1===l)var c=n&&!i;else{e||n||(k=g);var q=l-(g-k);q>0?e||(e=setTimeout(p,q)):(e&&(e=clearTimeout(e)),k=g,f=a.apply(h,d))}return i||b===l||(i=setTimeout(o,b)),c&&(f=a.apply(h,d)),f}}function w(a){return a}function x(a,b,c){var d=null==a,e=null==b;return null==c&&("boolean"==typeof a&&e?(c=a,a=1):e||"boolean"!=typeof b||(c=b,e=!0)),d&&e&&(b=1),a=+a||0,e?(b=a,a=0):b=+b||0,d=pb(),c||a%1||b%1?ob(a+d*(b-a+parseFloat("1e-"+((d+"").length-1))),b):a+_(d*(b-a+1))}var y,z=[],A=0,B={},C=40,D=/\w*$/,E=/^function[ \n\r\t]+\w/,F=/\bthis\b/,G="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),H="[object Arguments]",I="[object Array]",J="[object Boolean]",K="[object Date]",L="[object Error]",M="[object Number]",N="[object Object]",O="[object RegExp]",P="[object String]",Q={"[object Function]":!1};Q[H]=Q[I]=Q[J]=Q[K]=Q[M]=Q[N]=Q[O]=Q[P]=!0;var R={leading:!1,maxWait:0,trailing:!1},S={configurable:!1,enumerable:!1,value:null,writable:!1},T={a:"",b:null,c:"",d:"",e:"",v:null,g:"",h:null,support:null,i:"",j:!1},U={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},V=U[typeof b]&&b||this,W=[],X=Error.prototype,Y=Object.prototype,Z=String.prototype,$=RegExp("^"+(Y.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),_=Math.floor,ab=Function.prototype.toString,bb=$.test(bb=Object.getPrototypeOf)&&bb,cb=Y.hasOwnProperty,db=$.test(db=Date.now)&&db||function(){return+new Date},eb=W.push,fb=Y.propertyIsEnumerable,gb=Y.toString,hb=W.unshift,ib=function(){try{var a={},b=$.test(b=Object.defineProperty)&&b,c=b(a,a,a)&&b}catch(d){}return c}(),jb=$.test(jb=gb.bind)&&jb,kb=$.test(kb=Object.create)&&kb,lb=$.test(lb=Array.isArray)&&lb,mb=$.test(mb=Object.keys)&&mb,nb=Math.max,ob=Math.min,pb=Math.random,qb=W.slice;b=$.test(V.attachEvent);var rb=jb&&!/\n|true/.test(jb+b),sb={};sb[I]=Array,sb[J]=Boolean,sb[K]=Date,sb["[object Function]"]=Function,sb[N]=Object,sb[M]=Number,sb[O]=RegExp,sb[P]=String;var tb={};tb[I]=tb[K]=tb[M]={constructor:!0,toLocaleString:!0,toString:!0,valueOf:!0},tb[J]=tb[P]={constructor:!0,toString:!0,valueOf:!0},tb[L]=tb["[object Function]"]=tb[O]={constructor:!0,toString:!0},tb[N]={constructor:!0},function(){for(var a=G.length;a--;){var b,c=G[a];for(b in tb)cb.call(tb,b)&&!cb.call(tb[b],c)&&(tb[b][c]=!1)}}();var ub=g.support={};!function(){var a=function(){this.x=1},b={0:1,length:1},c=[];a.prototype={valueOf:1,y:1};for(var d in new a)c.push(d);for(d in arguments);ub.argsClass=gb.call(arguments)==H,ub.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),ub.enumErrorProps=fb.call(X,"message")||fb.call(X,"name"),ub.enumPrototypes=fb.call(a,"prototype"),ub.fastBind=jb&&!rb,ub.funcDecomp=!$.test(V.WinRTError)&&F.test(function(){return this}),ub.funcNames="string"==typeof Function.name,ub.nonEnumArgs=0!=d,ub.nonEnumShadows=!/valueOf/.test(c),ub.ownLast="x"!=c[0],ub.spliceObjects=(W.splice.call(b,0,1),!b[0]),ub.unindexedChars="xx"!="x"[0]+Object("x")[0];try{ub.nodeClass=!(gb.call(document)==N&&!({toString:0}+""))}catch(e){ub.nodeClass=!0}}(1),kb||(n=function(a){if(r(a)){d.prototype=a;var b=new d;d.prototype=null}return b||{}});var vb=ib?function(a,b){S.value=b,ib(a,"__bindData__",S)}:d;ub.argsClass||(p=function(a){return a&&"object"==typeof a&&"number"==typeof a.length&&cb.call(a,"callee")||!1});var wb=lb||function(a){return a&&"object"==typeof a&&"number"==typeof a.length&&gb.call(a)==I||!1},xb=m({a:"z",e:"[]",i:"if(!(B[typeof z]))return E",g:"E.push(n)"}),yb=mb?function(a){return r(a)?ub.enumPrototypes&&"function"==typeof a||ub.nonEnumArgs&&a.length&&p(a)?xb(a):mb(a):[]}:xb,lb={a:"g,e,K",i:"e=e&&typeof K=='undefined'?e:d(e,K,3)",b:"typeof u=='number'",v:yb,g:"if(e(t[n],n,g)===false)return E"};b={a:"z,H,l",i:"var a=arguments,b=0,c=typeof l=='number'?2:a.length;while(++b<c){t=a[b];if(t&&B[typeof t]){",v:yb,g:"if(typeof E[n]=='undefined')E[n]=t[n]",c:"}}"};var zb={i:"if(!B[typeof t])return E;"+lb.i,b:!1},Ab=m(lb),Bb=m(b,{i:b.i.replace(";",";if(c>3&&typeof a[c-2]=='function'){var e=d(a[--c-1],a[c--],2)}else if(c>2&&typeof a[c-1]=='function'){e=a[--c]}"),g:"E[n]=e?e(E[n],t[n]):t[n]"}),Cb=m(lb,zb,{j:!1}),Db=m(lb,zb);q(/x/)&&(q=function(a){return"function"==typeof a&&"[object Function]"==gb.call(a)}),lb=bb?function(a){if(!a||gb.call(a)!=N||!ub.argsClass&&p(a))return!1;var b=a.valueOf,c="function"==typeof b&&(c=bb(b))&&bb(c);return c?a==c||bb(a)==c:o(a)}:o,g.assign=Bb,g.bind=u,g.createCallback=function(a,b,c){var d=typeof a;if(null==a||"function"==d)return i(a,b,c);if("object"!=d)return function(b){return b[a]};var e=yb(a),f=e[0],g=a[f];return 1!=e.length||g!==g||r(g)?function(b){for(var c=e.length,d=!1;c--&&(d=j(b[e[c]],a[e[c]],null,!0)););return d}:function(a){return a=a[f],g===a&&(0!==g||1/g==1/a)}},g.debounce=v,g.forEach=t,g.forIn=Cb,g.forOwn=Db,g.keys=yb,g.shuffle=function(a){var b=-1,c=a?a.length:0,d=Array("number"==typeof c?c:0);return t(a,function(a){var c=x(++b);d[b]=d[c],d[c]=a}),d},g.throttle=function(a,b,c){var d=!0,e=!0;if(!q(a))throw new TypeError;return!1===c?d=!1:r(c)&&(d="leading"in c?c.leading:d,e="trailing"in c?c.trailing:e),R.leading=d,R.maxWait=b,R.trailing=e,v(a,b,R)},g.each=t,g.extend=Bb,g.clone=function(a,b,c,d){return"boolean"!=typeof b&&null!=b&&(d=c,c=b,b=!1),h(a,b,"function"==typeof c&&i(c,d,1))},g.identity=w,g.isArguments=p,g.isArray=wb,g.isFunction=q,g.isObject=r,g.isPlainObject=lb,g.isString=s,g.random=x,g.sortedIndex=function(a,b,c,d){var e=0,f=a?a.length:e;for(c=c?g.createCallback(c,d,1):w,b=c(b);f>e;)d=e+f>>>1,c(a[d])<b?e=d+1:f=d;return e},g.uniqueId=function(a){var b=++A;return(null==a?"":a)+""+b},g.VERSION="2.2.1",g.extend(a.util,g)}(this);var b=a.util.decorator=function(b,c){var d={},e={},f=function(b,c){return a.util.isFunction(c)?c:b},g=Object.getPrototypeOf;"function"!=typeof g&&(g="object"==typeof"test".__proto__?function(a){return a.__proto__}:function(a){return a.constructor.prototype});var h=Object.create;"function"!=typeof h&&(h=function(a){function b(){}return b.prototype=a,new b});var i=function(c,d){return"object"==typeof c?(e=a.util.extend(e,c,f),e.type=b,void 0):("type"!==c&&a.util.isFunction(d)&&(e[c]=d),void 0)};i(c);var j=function(c,i,j,k){var l,m=e;if("string"!=typeof i)k=j,j=i;else{if(m=d[i],!m)throw'Error: "'+i+'" '+b+" not defined";m=m.prototype}if("function"==typeof j)l=d[c],l?l.prototype=a.util.extend(l.prototype,j(g(l.prototype)),f):(l=d[c]=function(a){this.init&&this.init(a)},l.prototype=h(m),l.prototype=a.util.extend(l.prototype,j(m),f)),l.prototype.type=b,l.prototype.name=c;else if(k=j||{},l=d[c],!l)throw'Error: "'+c+'" '+b+" not defined";return k?new l(k):void 0};return j.mixin=i,j};return function(b){var c=b.Physics;a.noConflict=function(){return b.Physics===a&&(b.Physics=c),a}}(this),function(){var b=function c(a){return this instanceof c?(this.initPubsub(a),void 0):new c(a)};b.prototype={initPubsub:function(a){this._topics={},this._defaultScope=a||this},subscribe:function(b,c,d,e){var f,g=this._topics[b]||(this._topics[b]=[]),h=c;if(a.util.isObject(b)){for(var i in b)this.subscribe(i,b[i],c,d);return this}return a.util.isObject(d)?(c=a.util.bind(c,d),c._bindfn_=h):e||(e=d),c._priority_=e,f=a.util.sortedIndex(g,c,"_priority_"),g.splice(f,0,c),this},unsubscribe:function(a,b){if(a===!0)return this._topics={},this;var c,d=this._topics[a];if(!d)return this;if(b===!0)return this._topics[a]=[],this;for(var e=0,f=d.length;f>e;e++)if(c=d[e],c._bindfn_===b||c===b){d.splice(e,1);break}return this},publish:function(a){"object"!=typeof a&&(a={topic:a});var b=a.topic,c=this._topics[b],d=c&&c.length;if(!b)throw"Error: No topic specified in call to world.publish()";if(!d)return this;for(a.scope=a.scope||this._defaultScope;d--;)a.handler=c[d],a.handler(a);return this}},a.util.pubsub=b}(),function(a){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c){var d=(new Date).getTime(),e=Math.max(0,16-(d-b)),f=a.setTimeout(function(){c(d+e)},e);return b=d+e,f}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)})}(this),function(){var b=100,c=10,d="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",e="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",f="Error: Too many scratchpads created. (Did you forget to call .done()?)",g=[],h=0,i=function(){if(this.objIndex=0,this.arrayIndex=0,this.vectorIndex=0,this.aabbIndex=0,this.transformIndex=0,this.objectStack=[],this.arrayStack=[],this.vectorStack=[],this.aabbStack=[],this.transformStack=[],++h>=b)throw f};i.prototype={done:function(){this._active=!1,this.objIndex=this.arrayIndex=this.vectorIndex=this.aabbIndex=this.transformIndex=0,g.push(this)},object:function(){var a=this.objectStack;if(!this._active)throw d;if(this.objIndex>=c)throw e;return a[this.objIndex++]||a[a.push({})-1]},array:function(){var a=this.arrayStack;if(!this._active)throw d;if(this.arrIndex>=c)throw e;return a[this.arrIndex++]||a[a.push([])-1]},vector:function(){var b=this.vectorStack;if(!this._active)throw d;if(this.vectorIndex>=c)throw e;return b[this.vectorIndex++]||b[b.push(a.vector())-1]},aabb:function(){var b=this.aabbStack;if(!this._active)throw d;if(this.aabbIndex>=c)throw e;return b[this.aabbIndex++]||b[b.push(a.aabb())-1]},transform:function(){var b=this.transformStack;if(!this._active)throw d;if(this.transformIndex>=c)throw e;return b[this.transformIndex++]||b[b.push(a.transform())-1]}},a.scratchpad=function(){var a=g.pop()||new i;return a._active=!0,a}}(),function(b){function c(a){var d=k;if(j){b.requestAnimationFrame(c);for(var e=0,f=d.length;f>e;++e)d[e](a,a-i);i=a}}function d(){return i=(new Date).getTime(),j=!0,c(),this}function e(){return j=!1,this}function f(a){if("function"==typeof a){for(var b=0,c=k.length;c>b;++b)if(a===k[b])return this;k.push(a)}return this}function g(a){for(var b=k,c=0,d=b.length;d>c;++c)if(b[c]===a)return b.splice(c,1),this;return this}function h(){return!!j}var i=0,j=!1,k=[];a.util.ticker={start:d,stop:e,subscribe:f,unsubscribe:g,isActive:h}}(this),function(){var b=function c(b,d,e,f){return this instanceof c?(this._pos=a.vector(),this.set(b,d,e,f),void 0):new c(b,d,e,f)};b.prototype.set=function(b,c,d,e){return a.util.isObject(b)?(this._pos.clone(b.pos),this._hw=b.halfWidth,this._hh=b.halfHeight,this):(this._pos.set(.5*(d+b),.5*(e+c)),this._hw=.5*(d-b),this._hh=.5*(e-c),this)},b.prototype.get=function(){var a=this.halfWidth(),b=this.halfHeight();return{pos:this._pos.values(),halfWidth:a,halfHeight:b,x:a,y:b}},b.prototype.halfWidth=function(){return this._hw},b.prototype.halfHeight=function(){return this._hh},b.prototype.contains=function(a){var b=void 0!==a.x?a.x:a.get(0),c=void 0!==a.y?a.y:a.get(1);return b>this._pos.get(0)-this._hw&&b<this._pos.get(0)+this._hw&&c>this._pos.get(1)-this._hh&&c<this._pos.get(1)+this._hh},b.prototype.transform=function(b){var c=this._hw,d=this._hh,e=a.scratchpad(),f=e.vector().set(c,d),g=e.vector().set(c,-d);return this._pos.translate(b),f.rotate(b),g.rotate(b),this._hw=Math.max(Math.abs(f.get(0)),Math.abs(g.get(0))),this._hh=Math.max(Math.abs(f.get(1)),Math.abs(g.get(1))),e.done(),this},b.contains=function(a,b){var c=void 0!==b.x?b.x:b.get(0),d=void 0!==b.y?b.y:b.get(1);return a=a.get?a.get():a,c>a.pos.x-a.halfWidth&&c<a.pos.x+a.halfWidth&&d>a.pos.y-a.halfHeight&&d<a.pos.y+a.halfHeight},a.aabb=b}(),function(){var b=1e-4,c=100,d=function(a,b,c){var d=b.normSq()-b.dot(a),e=b.dot(a)-a.normSq();return 0>d?c.clone(b).negate():e>0?c.clone(a).negate():(c.clone(b).vsub(a),c.perp(a.cross(c)<0))},e=function(b){var c,d,e=b.length,f=b[e-2],g=b[e-3],h=a.scratchpad(),i=h.vector().clone(f.pt),j=h.vector().clone(g.pt).vsub(i);if(j.equals(a.vector.zero))return h.done(),{a:f.a,b:f.b};if(c=-j.dot(i)/j.normSq(),d=1-c,0>=d)return h.done(),{a:g.a,b:g.b};if(0>=c)return h.done(),{a:f.a,b:f.b};var k={a:i.clone(f.a).mult(d).vadd(j.clone(g.a).mult(c)).values(),b:i.clone(f.b).mult(d).vadd(j.clone(g.b).mult(c)).values()};return h.done(),k},f=function(f,g,h,i){var j,k,l,m,n=!1,o=!1,p=!1,q=[],r=1,s=a.scratchpad(),t=s.vector().clone(g||a.vector.axis[0]),u=s.vector(),v=s.vector(),w=s.vector(),x=s.vector(),y=0;for(m=f(t),r=q.push(m),u.clone(m.pt),t.negate();++y;){if(u.swap(v),m=f(t),r=q.push(m),u.clone(m.pt),i&&i(q),u.equals(a.vector.zero)){n=!0;break}if(!o&&u.dot(t)<=0){if(h)break;o=!0}if(2===r)t=d(u,v,t);else if(o){if(t.normalize(),m=v.dot(t),Math.abs(m-u.dot(t))<b){p=-m;break}v.normSq()<w.clone(q[0].pt).normSq()?q.shift():q.splice(1,1),t=d(w.clone(q[1].pt),x.clone(q[0].pt),t)}else if(j=j||s.vector(),k=k||s.vector(),j.clone(v).vsub(u),k.clone(q[0].pt).vsub(u),l=j.cross(k)>0,l^u.cross(j)>0)q.shift(),j.perp(l),t.swap(j);else{if(!(l^k.cross(u)>0)){n=!0;break}q.splice(1,1),k.perp(!l),t.swap(j)}if(y>c)return s.done(),{simplex:q,iterations:y,distance:0,maxIterationsReached:!0}}return s.done(),m={overlap:n,simplex:q,iterations:y},p!==!1&&(m.distance=p,m.closest=e(q)),m};a.gjk=f}(),function(){var b=function c(b,d,e){return this instanceof c?(this.v=a.vector(),this.o=a.vector(),b instanceof c?(this.clone(b),void 0):(b&&this.setTranslation(b),this.setRotation(d||0,e),void 0)):new c(b,d)};b.prototype.setTranslation=function(a){return this.v.clone(a),this},b.prototype.setRotation=function(a,b){return this.cosA=Math.cos(a),this.sinA=Math.sin(a),b?this.o.clone(b):this.o.zero(),this},b.prototype.clone=function(a){return a?(this.setTranslation(a.v),this.cosA=a.cosA,this.sinA=a.sinA,this.o.clone(a.o),this):new b(this)},a.transform=b}(),function(b){var c=Math.sqrt,d=Math.min,e=Math.max,f=(Math.acos,Math.atan2),g=2*Math.PI,h=!!b.Float64Array,i=function j(a,b){return this instanceof j?(this._=h?new Float64Array(5):[],a&&(void 0!==a.x||a._&&a._.length)?this.clone(a):(this.recalc=!0,this.set(a||0,b||0)),void 0):new j(a,b)};i.prototype.set=function(a,b){return this.recalc=!0,this._[0]=a||0,this._[1]=b||0,this},i.prototype.get=function(a){return this._[a]},i.prototype.vadd=function(a){return this.recalc=!0,this._[0]+=a._[0],this._[1]+=a._[1],this},i.prototype.vsub=function(a){return this.recalc=!0,this._[0]-=a._[0],this._[1]-=a._[1],this},i.prototype.add=function(a,b){return this.recalc=!0,this._[0]+=a,this._[1]+=void 0===b?a:b,this},i.prototype.sub=function(a,b){return this.recalc=!0,this._[0]-=a,this._[1]-=void 0===b?a:b,this},i.prototype.mult=function(a){return this.recalc||(this._[4]*=a*a,this._[3]*=a),this._[0]*=a,this._[1]*=a,this},i.prototype.dot=function(a){return this._[0]*a._[0]+this._[1]*a._[1]},i.prototype.cross=function(a){return-this._[0]*a._[1]+this._[1]*a._[0]},i.prototype.proj=function(a){return this.dot(a)/a.norm()},i.prototype.vproj=function(a){var b=this.dot(a)/a.normSq();return this.clone(a).mult(b)},i.prototype.angle=function(a){var b;if(this.equals(i.zero))return a?a.angle():0/0;for(b=a&&!a.equals(i.zero)?f(this._[1]*a._[0]-this._[0]*a._[1],this._[0]*a._[0]+this._[1]*a._[1]):f(this._[1],this._[0]);b>Math.PI;)b-=g;for(;b<-Math.PI;)b+=g;return b},i.prototype.angle2=function(a,b){for(var c=a._[0]-this._[0],d=a._[1]-this._[1],e=b._[0]-this._[0],h=b._[1]-this._[1],i=f(d*e-c*h,c*e+d*h);i>Math.PI;)i-=g;for(;i<-Math.PI;)i+=g;return i},i.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=c(this._[4])),this._[3]},i.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=c(this._[4])),this._[4]},i.prototype.dist=function(a){var b,d;return c((b=a._[0]-this._[0])*b+(d=a._[1]-this._[1])*d)},i.prototype.distSq=function(a){var b,c;return(b=a._[0]-this._[0])*b+(c=a._[1]-this._[1])*c},i.prototype.perp=function(a){var b=this._[0];return a?(this._[0]=-this._[1],this._[1]=b):(this._[0]=this._[1],this._[1]=-b),this},i.prototype.normalize=function(){var a=this.norm();return 0===a?this:(a=1/a,this._[0]*=a,this._[1]*=a,this._[3]=1,this._[4]=1,this)},i.prototype.transform=function(a){var b=a.sinA,c=a.cosA,d=a.o._[0],e=a.o._[1];return this._[0]-=d,this._[1]-=e,this.set(this._[0]*c-this._[1]*b+d+a.v._[0],this._[0]*b+this._[1]*c+e+a.v._[1])},i.prototype.transformInv=function(a){var b=a.sinA,c=a.cosA,d=a.o._[0],e=a.o._[1];return this._[0]-=d+a.v._[0],this._[1]-=e+a.v._[1],this.set(this._[0]*c+this._[1]*b+d,-this._[0]*b+this._[1]*c+e)},i.prototype.rotate=function(a,b){var c,d,e=0,f=0;return"number"==typeof a?(c=Math.sin(a),d=Math.cos(a),b&&(e=0|(b.x||b._[0]),f=0|(b.y||b._[1]))):(c=a.sinA,d=a.cosA,e=a.o._[0],f=a.o._[1]),this._[0]-=e,this._[1]-=f,this.set(this._[0]*d-this._[1]*c+e,this._[0]*c+this._[1]*d+f)},i.prototype.rotateInv=function(a){return this.set((this._[0]-a.o._[0])*a.cosA+(this._[1]-a.o._[1])*a.sinA+a.o._[0],-(this._[0]-a.o._[0])*a.sinA+(this._[1]-a.o._[1])*a.cosA+a.o._[1])},i.prototype.translate=function(a){return this.vadd(a.v)},i.prototype.translateInv=function(a){return this.vsub(a.v)},i.prototype.clone=function(a){return a?a._?(this.recalc=a.recalc,a.recalc||(this._[3]=a._[3],this._[4]=a._[4]),this._[0]=a._[0],this._[1]=a._[1],this):this.set(a.x,a.y):new i(this)},i.prototype.swap=function(a){var b=this._;return this._=a._,a._=b,b=this.recalc,this.recalc=a.recalc,a.recalc=b,this},i.prototype.values=function(){return{x:this._[0],y:this._[1]}},i.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this},i.prototype.negate=function(a){return void 0!==a?(this._[a]=-this._[a],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)},i.prototype.clamp=function(a,b){return a=a.values?a.values():a,b=b.values?b.values():b,this._[0]=d(e(this._[0],a.x),b.x),this._[1]=d(e(this._[1],a.y),b.y),this.recalc=!0,this},i.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"},i.prototype.equals=function(a){return this._[0]===a._[0]&&this._[1]===a._[1]&&this._[2]===a._[2]},i.vadd=function(a,b){return new i(a._[0]+b._[0],a._[1]+b._[1])},i.vsub=function(a,b){return new i(a._[0]-b._[0],a._[1]-b._[1])},i.mult=function(a,b){return new i(b._[0]*a,b._[1]*a)},i.vproj=function(a,b){return i.mult(a.dot(b)/b.normSq(),b)},i.axis=[new i(1,0),new i(0,1)],i.zero=new i(0,0),a.vector=i}(this),function(){a.behavior=a.behaviour=b("behavior",{priority:0,init:function(){this.options={}},connect:function(a){this.behave&&a.subscribe("integrate:positions",this.behave,this,this.priority)},disconnect:function(a){this.behave&&a.unsubscribe("integrate:positions",this.behave)},behave:null})}(),function(){var c={fixed:!1,mass:1,restitution:1,cof:.8,view:null};a.body=b("body",{init:function(b){var d=a.vector;if(this.options=a.util.extend({},c,b),this.fixed=this.options.fixed,this.hidden=this.options.hidden,this.mass=this.options.mass,this.restitution=this.options.restitution,this.cof=this.options.cof,this.view=this.options.view,this.state={pos:d(b.x,b.y),vel:d(b.vx,b.vy),acc:d(),angular:{pos:b.angle||0,vel:b.angularVelocity||0,acc:0},old:{pos:d(),vel:d(),acc:d(),angular:{pos:0,vel:0,acc:0}}},0===this.mass)throw"Error: Bodies must have non-zero mass";this.geometry=a.geometry("point")},accelerate:function(a){return this.state.acc.vadd(a),this},applyForce:function(b,c){var d,e=a.scratchpad(),f=e.vector();return c?this.moi&&(d=this.state,f.clone(c),this.state.angular.acc-=f.cross(b)/this.moi,this.applyForce(b)):this.accelerate(f.clone(b).mult(1/this.mass)),e.done(),this},aabb:function(){var b=a.scratchpad(),c=b.transform(),d=this.state.angular.pos,e=b.aabb().set(this.geometry.aabb(d));return c.setRotation(0).setTranslation(this.state.pos),e.transform(c),e=e.get(),b.done(),e},recalc:function(){}})}(),function(){a.geometry=b("geometry",{init:function(){this._aabb=new a.aabb},aabb:function(){return this._aabb.get()},getFarthestHullPoint:function(b,c){return c=c||a.vector(),c.set(0,0)},getFarthestCorePoint:function(b,c){return c=c||a.vector(),c.set(0,0)}})}(),a.geometry.isPolygonConvex=function(b){var c=a.scratchpad(),d=c.vector(),e=c.vector(),f=c.vector(),g=!0,h=!1,i=b.length;if(!b||!i)return!1;if(3>i)return c.done(),g;d.clone(b[0]).vsub(f.clone(b[i-1]));for(var j=1;i>=j;++j){if(e.clone(b[j%i]).vsub(f.clone(b[(j-1)%i])),h===!1)h=d.cross(e);else if(h>0^d.cross(e)>0){g=!1;break}e.swap(d)}return c.done(),g},a.geometry.getPolygonMOI=function(b){var c,d=a.scratchpad(),e=d.vector(),f=d.vector(),g=0,h=0,i=b.length;if(2>i)return d.done(),0;if(2===i)return c=f.clone(b[1]).distSq(e.clone(b[0])),d.done(),c/12;e.clone(b[0]);for(var j=1;i>j;++j)f.clone(b[j]),c=Math.abs(f.cross(e)),g+=c*(f.normSq()+f.dot(e)+e.normSq()),h+=c,e.swap(f);return d.done(),g/(6*h)},a.geometry.isPointInPolygon=function(b,c){var d=a.scratchpad(),e=d.vector().clone(b),f=d.vector(),g=d.vector(),h=0,i=c.length;if(2>i)return h=e.equals(f.clone(c[0])),d.done(),h;if(2===i)return h=e.angle(f.clone(c[0])),h+=e.angle(f.clone(c[1])),d.done(),Math.abs(h)===Math.PI;f.clone(c[0]).vsub(e);for(var j=1;i>=j;++j)g.clone(c[j%i]).vsub(e),h+=g.angle(f),f.swap(g);return d.done(),Math.abs(h)>0},a.geometry.getPolygonArea=function(b){var c=a.scratchpad(),d=c.vector(),e=c.vector(),f=0,g=b.length;if(3>g)return c.done(),0;d.clone(b[g-1]);for(var h=0;g>h;++h)e.clone(b[h]),f+=d.cross(e),d.swap(e);return c.done(),f/2},a.geometry.getPolygonCentroid=function(b){var c,d=a.scratchpad(),e=d.vector(),f=d.vector(),g=a.vector(),h=b.length;if(2>h)return d.done(),a.vector(b[0]);if(2===h)return d.done(),a.vector((b[1].x+b[0].x)/2,(b[1].y+b[0].y)/2);e.clone(b[h-1]);for(var i=0;h>i;++i)f.clone(b[i]),c=e.cross(f),e.vadd(f).mult(c),g.vadd(e),e.swap(f);return c=1/(6*a.geometry.getPolygonArea(b)),d.done(),g.mult(c)},a.geometry.nearestPointOnLine=function(b,c,d){var e,f,g=a.scratchpad(),h=g.vector().clone(b),i=g.vector().clone(c).vsub(h),j=g.vector().clone(d).vsub(h).vsub(i);return j.equals(a.vector.zero)?(g.done(),a.vector(c)):(e=-j.dot(i)/j.normSq(),f=1-e,0>=f?(g.done(),a.vector(d)):0>=e?(g.done(),a.vector(c)):(h=a.vector(d).mult(e).vadd(i.clone(c).mult(f)),g.done(),h))},function(){var c={drag:0};a.integrator=b("integrator",{init:function(b){this.options=a.util.extend({},c,b)},integrate:function(a,b){var c=this._world;return this.integrateVelocities(a,b),c&&c.publish({topic:"integrate:velocities",bodies:a,dt:b}),this.integratePositions(a,b),c&&c.publish({topic:"integrate:positions",bodies:a,dt:b}),this},integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden"},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden"}})}(),function(){var c={meta:!1,metaRefresh:200,width:600,height:600};a.renderer=b("renderer",{init:function(b){var d="string"==typeof b.el?document.getElementById(b.el):b.el;this.options=a.util.extend({},c,b),this.el=d?d:document.body,this.drawMeta=a.util.throttle(a.util.bind(this.drawMeta,this),this.options.metaRefresh)},render:function(a,b){var c,d;this.beforeRender&&this.beforeRender(),this._world.publish({topic:"beforeRender",renderer:this,bodies:a,stats:b}),this.options.meta&&this.drawMeta(b);for(var e=0,f=a.length;f>e;++e)c=a[e],d=c.view||(c.view=this.createView(c.geometry)),c.hidden||this.drawBody(c,d);return this},createView:function(){throw"You must overried the renderer.createView() method."},drawMeta:function(){throw"You must overried the renderer.drawMeta() method."},drawBody:function(){throw"You must overried the renderer.drawBody() method."}})}(),function(){var b=function(a){this.disconnect&&this._world&&this.disconnect(this._world),this._world=a,this.connect&&a&&this.connect(a)};a.util.each("body,behavior,integrator,renderer".split(","),function(c){a[c].mixin("setWorld",b)});var c=function f(a,b,c){for(var d,e,g=function(){return f(a,b,c)};d=a.shift();)if(e=d.apply(b,c),e&&e.then)return e.then(g)},d={timestep:6.25,maxIPF:16,webworker:!1,integrator:"verlet"},e=function g(a,b){return this instanceof g?(this.init(a,b),void 0):new g(a,b)};e.prototype=a.util.extend({},a.util.pubsub.prototype,{init:function(b,d){(a.util.isFunction(b)||a.util.isArray(b))&&(d=b,b={}),this._stats={fps:0,ipf:0},this._bodies=[],this._behaviors=[],this._integrator=null,this._renderer=null,this._paused=!1,this._opts={},this.initPubsub(this),this.options(b||{}),a.util.isFunction(d)?c([d],this,[this,a]):a.util.isArray(d)&&c(d,this,[this,a])},options:function(b){return b?(a.util.extend(this._opts,d,b),this.timeStep(this._opts.timestep),this.add(a.integrator(this._opts.integrator)),this):a.util.clone(this._opts)},add:function(a){var b,c=0,d=a&&a.length||0,e=d?a[0]:a;if(!e)return this;do{switch(e.type){case"behavior":this.addBehavior(e);break;case"integrator":this.integrator(e);break;case"renderer":this.renderer(e);break;case"body":this.addBody(e);break;default:throw'Error: failed to add item of unknown type "'+e.type+'" to world'}b={topic:"add:"+e.type},b[e.type]=e,this.publish(b)}while(++c<d&&(e=a[c]));return this},remove:function(a){var b,c=0,d=a&&a.length||0,e=d?a[0]:a;if(!e)return this;do{switch(e.type){case"behavior":this.removeBehavior(e);break;case"integrator":e===this._integrator&&this.integrator(null);break;case"renderer":e===this._renderer&&this.renderer(null);break;case"body":this.removeBody(e);break;default:throw'Error: failed to remove item of unknown type "'+e.type+'" from world'}b={topic:"add:"+e.type},b[e.type]=e,this.publish(b)}while(++c<d&&(e=a[c]));return this},integrator:function(a){return void 0===a?this._integrator:(this._integrator&&this._integrator.setWorld(null),a&&(this._integrator=a,this._integrator.setWorld(this)),this)},renderer:function(a){return void 0===a?this._renderer:(this._renderer&&this._renderer.setWorld(null),a&&(this._renderer=a,this._renderer.setWorld(this)),this)},timeStep:function(a){return a?(this._dt=a,this._maxJump=a*this._opts.maxIPF,this):this._dt},addBehavior:function(a){return a.setWorld(this),this._behaviors.push(a),this
},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(a){var b,c=this._behaviors;if(a){for(var d=0,e=c.length;e>d;++d)if(a===c[d]){c.splice(d,1);break}b={topic:"remove:behavior"},b.behavior=a,this.publish(b)}return this},addBody:function(a){return a.setWorld(this),this._bodies.push(a),this},getBodies:function(){return[].concat(this._bodies)},removeBody:function(a){var b,c=this._bodies;if(a){for(var d=0,e=c.length;e>d;++d)if(a===c[d]){c.splice(d,1);break}b={topic:"remove:body"},b.body=a,this.publish(b)}return this},findOne:function(b){var c={check:function(a){for(var b=this;b=b.next;)if(b(a))return!0;return!1}},d=c,e=this._bodies;b.$within,b.$at&&(d.next=function(c){var d=c.aabb();return a.aabb.contains(d,b.$at)});for(var f=0,g=e.length;g>f;++f)if(c.check(e[f]))return e[f];return!1},iterate:function(a){this._integrator.integrate(this._bodies,a)},step:function(a){if(this._paused)return this._time=!1,this;var b=this._time||(this._time=a),c=a-b,d=this._stats,e=this._dt;if(!c)return this;for(c>this._maxJump&&(this._time=a-this._maxJump,c=this._maxJump),d.fps=1e3/c,d.ipf=Math.ceil(c/this._dt);this._time<a;)this._time+=e,this.iterate(e);return this.publish({topic:"step"}),this},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._stats),this.publish({topic:"render",bodies:this._bodies,stats:this._stats,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.publish({topic:"pause"}),this},unpause:function(){return this._paused=!1,this.publish({topic:"unpause"}),this},isPaused:function(){return!!this._paused},destroy:function(){var a=this;a.pause(),a.unsubscribe(!0),a.remove(a.getBodies()),a.remove(a.getBehaviors()),a.integrator(null),a.renderer(null)}}),a.world=e}(),a.integrator("verlet",function(b){return a.body.mixin({started:function(a){return void 0!==a&&(this._started=!0),!!this._started}}),{init:function(a){b.init.call(this,a)},integrateVelocities:function(a,b){for(var c,d=b*b,e=1-this.options.drag,f=null,g=0,h=a.length;h>g;++g)f=a[g],c=f.state,f.fixed?(c.vel.zero(),c.acc.zero(),c.angular.vel=0,c.angular.acc=0):(c.vel.equals(c.old.vel)&&f.started()?c.vel.clone(c.pos).vsub(c.old.pos):(c.old.pos.clone(c.pos).vsub(c.vel),c.vel.mult(b)),e&&c.vel.mult(e),c.vel.vadd(c.acc.mult(d)),c.vel.mult(1/b),c.old.vel.clone(c.vel),c.acc.zero(),c.angular.vel===c.old.angular.vel&&f.started()?c.angular.vel=c.angular.pos-c.old.angular.pos:(c.old.angular.pos=c.angular.pos-c.angular.vel,c.angular.vel*=b),c.angular.vel+=c.angular.acc*d,c.angular.vel/=b,c.old.angular.vel=c.angular.vel,c.angular.acc=0,f.started(!0))},integratePositions:function(a,b){for(var c,d=null,e=0,f=a.length;f>e;++e)d=a[e],c=d.state,d.fixed||(c.vel.mult(b),c.old.pos.clone(c.pos),c.pos.vadd(c.vel),c.vel.mult(1/b),c.old.vel.clone(c.vel),c.angular.vel*=b,c.old.angular.pos=c.angular.pos,c.angular.pos+=c.angular.vel,c.angular.vel/=b,c.old.angular.vel=c.angular.vel)}}}),a.geometry("point",function(){}),a.geometry("circle",function(b){var c={radius:1};return{init:function(d){b.init.call(this,d),d=a.util.extend({},c,d),this.radius=d.radius,this._aabb=a.aabb()},aabb:function(){var a=this.radius,b=this._aabb;return b.halfWidth()===a?b.get():b.set(-a,-a,a,a).get()},getFarthestHullPoint:function(b,c){return c=c||a.vector(),c.clone(b).normalize().mult(this.radius)},getFarthestCorePoint:function(b,c,d){return c=c||a.vector(),c.clone(b).normalize().mult(this.radius-d)}}}),a.geometry("convex-polygon",function(b){var c="Error: The vertices specified do not match that of a _convex_ polygon.",d={};return{init:function(c){b.init.call(this,c),c=a.util.extend({},d,c),this.setVertices(c.vertices||[])},setVertices:function(b){var d=a.scratchpad(),e=d.transform(),f=this.vertices=[];if(!a.geometry.isPolygonConvex(b))throw c;e.setRotation(0),e.setTranslation(a.geometry.getPolygonCentroid(b).negate());for(var g=0,h=b.length;h>g;++g)f.push(a.vector(b[g]).translate(e));return this._area=a.geometry.getPolygonArea(f),this._aabb=!1,d.done(),this},aabb:function(b){if(!b&&this._aabb)return this._aabb.get();var c,d=a.scratchpad(),e=d.vector(),f=d.transform().setRotation(b||0),g=d.vector().clone(a.vector.axis[0]).rotateInv(f),h=d.vector().clone(a.vector.axis[1]).rotateInv(f),i=this.getFarthestHullPoint(g,e).proj(g),j=-this.getFarthestHullPoint(g.negate(),e).proj(g),k=this.getFarthestHullPoint(h,e).proj(h),l=-this.getFarthestHullPoint(h.negate(),e).proj(h);return c=new a.aabb(j,l,i,k),b||(this._aabb=c),d.done(),c.get()},getFarthestHullPoint:function(b,c,d){var e,f,g,h=this.vertices,i=h.length,j=2;if(c=c||a.vector(),2>i)return d&&(d.idx=0),c.clone(h[0]);if(f=h[0].dot(b),e=h[1].dot(b),2===i)return g=e>=f?1:0,d&&(d.idx=g),c.clone(h[g]);if(e>=f){for(;i>j&&e>=f;)f=e,e=h[j].dot(b),j++;return e>=f&&j++,g=j-2,d&&(d.idx=j-2),c.clone(h[g])}for(j=i;j>2&&f>=e;)j--,e=f,f=h[j].dot(b);return g=(j+1)%i,d&&(d.idx=g),c.clone(h[g])},getFarthestCorePoint:function(b,c,d){var e,f=a.scratchpad(),g=f.vector(),h=f.vector(),i=this.vertices,j=i.length,k=this._area>0,l={};return c=this.getFarthestHullPoint(b,c,l),g.clone(i[(l.idx+1)%j]).vsub(c).normalize().perp(!k),h.clone(i[(l.idx-1+j)%j]).vsub(c).normalize().perp(k),e=d/(1+g.dot(h)),c.vadd(g.vadd(h).mult(e)),f.done(),c}}}),a.body("circle",function(b){var c={radius:1};return{init:function(d){b.init.call(this,d),d=a.util.extend({},c,d),this.geometry=a.geometry("circle",{radius:d.radius}),this.recalc()},recalc:function(){b.recalc.call(this),this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),a.body("convex-polygon",function(b){var c={};return{init:function(d){b.init.call(this,d),d=a.util.extend({},c,d),this.geometry=a.geometry("convex-polygon",{vertices:d.vertices}),this.recalc()},recalc:function(){b.recalc.call(this),this.moi=a.geometry.getPolygonMOI(this.geometry.vertices)}}}),a.body("point",function(){}),a.behavior("body-collision-detection",function(b){var c="collisions:candidates",d="collisions:detected",e=function(b,c){var d;return d=function(e){var f,g=a.scratchpad(),h=g.transform().setTranslation(b.state.pos).setRotation(b.state.angular.pos),i=g.transform().setTranslation(c.state.pos).setRotation(c.state.angular.pos),j=g.vector(),k=g.vector(),l=d.useCore?"getFarthestCorePoint":"getFarthestHullPoint",m=d.marginA,n=d.marginB;return j=b.geometry[l](e.rotateInv(h),j,m).transform(h),k=c.geometry[l](e.rotate(h).rotateInv(i).negate(),k,n).transform(i),e.negate().rotate(i),f={a:j.values(),b:k.values(),pt:j.vsub(k).values()},g.done(),f},d.useCore=!1,d.margin=0,d},f=function(b,c){var d,f,g,h=a.scratchpad(),i=h.vector(),j=h.vector(),k=!1,l=b.aabb(),m=Math.min(l.halfWidth,l.halfHeight),n=c.aabb(),o=Math.min(n.halfWidth,n.halfHeight);if(g=e(b,c),i.clone(b.state.pos).vsub(c.state.pos),f=a.gjk(g,i,!0),f.overlap){for(k={bodyA:b,bodyB:c},g.useCore=!0,g.marginA=0,g.marginB=0;f.overlap&&(g.marginA<m||g.marginB<o);)g.marginA<m&&(g.marginA+=1),g.marginB<o&&(g.marginB+=1),f=a.gjk(g,i);if(f.overlap||f.maxIterationsReached)return h.done(),!1;d=Math.max(0,g.marginA+g.marginB-f.distance),k.overlap=d,k.norm=i.clone(f.closest.b).vsub(j.clone(f.closest.a)).normalize().values(),k.mtv=i.mult(d).values(),k.pos=i.clone(k.norm).mult(g.margin).vadd(j.clone(f.closest.a)).vsub(b.state.pos).values()}return h.done(),k},g=function(b,c){var d,e=a.scratchpad(),f=e.vector(),g=(e.vector(),!1);return f.clone(c.state.pos).vsub(b.state.pos),d=f.norm()-(b.geometry.radius+c.geometry.radius),f.equals(a.vector.zero)&&f.set(1,0),0>=d&&(g={bodyA:b,bodyB:c,norm:f.normalize().values(),mtv:f.mult(-d).values(),pos:f.normalize().mult(b.geometry.radius).values(),overlap:-d}),e.done(),g},h=function(a,b){return"circle"===a.geometry.name&&"circle"===b.geometry.name?g(a,b):f(a,b)},i={checkAll:!1};return{init:function(c){b.init.call(this,c),this.options=a.util.extend({},this.options,i,c)},connect:function(a){this.options.checkAll?a.subscribe("integrate:velocities",this.checkAll,this):a.subscribe(c,this.check,this)},disconnect:function(a){this.options.checkAll?a.unsubscribe("integrate:velocities",this.checkAll):a.unsubscribe(c,this.check)},check:function(a){for(var b,c,e=a.candidates,f=[],g=0,i=e.length;i>g;++g)b=e[g],c=h(b.bodyA,b.bodyB),c&&f.push(c);f.length&&this._world.publish({topic:d,collisions:f})},checkAll:function(a){for(var b,c,e,f=a.bodies,g=(a.dt,[]),i=0,j=f.length;j>i;i++){b=f[i];for(var k=i+1;j>k;k++)c=f[k],b.fixed&&c.fixed||(e=h(b,c),e&&g.push(e))}g.length&&this._world.publish({topic:d,collisions:g})}}}),a.behavior("body-impulse-response",function(){var b="collisions:detected";return{connect:function(a){a.subscribe(b,this.respond,this)},disconnect:function(a){a.unsubscribe(b,this.respond)},collideBodies:function(b,c,d,e,f,g){var h=b.fixed,i=c.fixed,j=a.scratchpad(),k=j.vector().clone(f);if(h&&i)return j.done(),void 0;h?c.state.pos.vadd(k):i?b.state.pos.vsub(k):(k.mult(.5),b.state.pos.vsub(k),c.state.pos.vadd(k));var l,m,n,o=h?0:1/b.moi,p=i?0:1/c.moi,q=h?0:1/b.mass,r=i?0:1/c.mass,s=g?0:b.restitution*c.restitution,t=b.cof*c.cof,u=j.vector().clone(d),v=j.vector().clone(u).perp(!0),w=j.vector().clone(e),x=j.vector().clone(e).vadd(b.state.pos).vsub(c.state.pos),y=j.vector(),z=b.state.angular.vel,A=c.state.angular.vel,B=j.vector().clone(c.state.vel).vadd(y.clone(x).perp(!0).mult(A)).vsub(b.state.vel).vsub(y.clone(w).perp(!0).mult(z)),C=w.proj(u),D=w.proj(v),E=x.proj(u),F=x.proj(v),G=B.proj(u),H=B.proj(v),I=!1;return G>=0?(j.done(),void 0):(l=-((1+s)*G)/(q+r+o*D*D+p*F*F),h?(c.state.vel.vadd(u.mult(l*r)),c.state.angular.vel-=l*p*F):i?(b.state.vel.vsub(u.mult(l*q)),b.state.angular.vel+=l*o*D):(c.state.vel.vadd(u.mult(l*r)),c.state.angular.vel-=l*p*F,b.state.vel.vsub(u.mult(q*c.mass)),b.state.angular.vel+=l*o*D),t&&H&&(n=H/(q+r+o*C*C+p*E*E),I?l=n:(m=0>H?-1:1,l*=m*t,l=1===m?Math.min(l,n):Math.max(l,n)),h?(c.state.vel.vsub(v.mult(l*r)),c.state.angular.vel-=l*p*E):i?(b.state.vel.vadd(v.mult(l*q)),b.state.angular.vel+=l*o*C):(c.state.vel.vsub(v.mult(l*r)),c.state.angular.vel-=l*p*E,b.state.vel.vadd(v.mult(q*c.mass)),b.state.angular.vel+=l*o*C)),j.done(),void 0)},respond:function(b){for(var c,d=this,e=a.util.shuffle(b.collisions),f=0,g=e.length;g>f;++f)c=e[f],d.collideBodies(c.bodyA,c.bodyB,c.norm,c.pos,c.mtv)}}}),a.behavior("constant-acceleration",function(b){var c={acc:{x:0,y:4e-4}};return{init:function(d){b.init.call(this,d),this.options=a.util.extend(this.options,c,d),this._acc=a.vector(),this.setAcceleration(this.options.acc)},setAcceleration:function(a){return this._acc.clone(a),this},behave:function(a){for(var b=a.bodies,c=0,d=b.length;d>c;++c)b[c].accelerate(this._acc)}}}),a.behavior("edge-collision-detection",function(b){var c="collisions:detected",d=function(b,c,d){var e,f=b.aabb(),g=a.scratchpad(),h=g.transform(),i=g.vector(),j=g.vector(),k=!1,l=[];return e=f.pos.x+f.x-c.max.x,e>=0&&(i.set(1,0).rotateInv(h.setRotation(b.state.angular.pos)),k={bodyA:b,bodyB:d,overlap:e,norm:{x:1,y:0},mtv:{x:e,y:0},pos:b.geometry.getFarthestHullPoint(i,j).rotate(h).values()},l.push(k)),e=f.pos.y+f.y-c.max.y,e>=0&&(i.set(0,1).rotateInv(h.setRotation(b.state.angular.pos)),k={bodyA:b,bodyB:d,overlap:e,norm:{x:0,y:1},mtv:{x:0,y:e},pos:b.geometry.getFarthestHullPoint(i,j).rotate(h).values()},l.push(k)),e=c.min.x-(f.pos.x-f.x),e>=0&&(i.set(-1,0).rotateInv(h.setRotation(b.state.angular.pos)),k={bodyA:b,bodyB:d,overlap:e,norm:{x:-1,y:0},mtv:{x:-e,y:0},pos:b.geometry.getFarthestHullPoint(i,j).rotate(h).values()},l.push(k)),e=c.min.y-(f.pos.y-f.y),e>=0&&(i.set(0,-1).rotateInv(h.setRotation(b.state.angular.pos)),k={bodyA:b,bodyB:d,overlap:e,norm:{x:0,y:-1},mtv:{x:0,y:-e},pos:b.geometry.getFarthestHullPoint(i,j).rotate(h).values()},l.push(k)),g.done(),l},e=function(a,b,c){return d(a,b,c)},f={aabb:null,restitution:.99,cof:1};return{init:function(c){b.init.call(this,c),this.options=a.util.extend({},this.options,f,c),this.setAABB(c.aabb),this.restitution=c.restitution,this._dummy=a.body("_dummy",function(){},{fixed:!0,restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(a){if(!a)throw"Error: aabb not set";a=a.get&&a.get()||a,this._edges={min:{x:a.pos.x-a.x,y:a.pos.y-a.y},max:{x:a.pos.x+a.x,y:a.pos.y+a.y}}},connect:function(a){a.subscribe("integrate:velocities",this.checkAll,this)},disconnect:function(a){a.unsubscribe("integrate:velocities",this.checkAll)},checkAll:function(a){for(var b,d,f=a.bodies,g=(a.dt,[]),h=this._edges,i=this._dummy,j=0,k=f.length;k>j;j++)b=f[j],b.fixed||(d=e(b,h,i),d&&g.push.apply(g,d));g.length&&this._world.publish({topic:c,collisions:g})}}}),a.behavior("newtonian",function(b){var c={strength:1};return{init:function(d){b.init.call(this,d),d=a.util.extend({},c,d),this.strength=d.strength,this.tolerance=d.tolerance||100*this.strength},behave:function(b){for(var c,d,e,f,g=b.bodies,h=this.strength,i=this.tolerance,j=a.scratchpad(),k=j.vector(),l=0,m=g.length;m>l;l++){c=g[l];for(var n=l+1;m>n;n++)d=g[n],k.clone(d.state.pos),k.vsub(c.state.pos),e=k.normSq(),e>i&&(f=h/e,c.accelerate(k.normalize().mult(f*d.mass)),d.accelerate(k.mult(c.mass/d.mass).negate()))}j.done()}}}),a.behavior("rigid-constraint-manager",function(b){var c={targetLength:20};return{init:function(d){b.init.call(this,d),a.util.extend(this.options,c,d),this._constraints=[]},connect:function(a){var b=a.integrator();if(b&&b.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';a.subscribe("integrate:positions",this.resolve,this)},disconnect:function(a){a.unsubscribe("integrate:positions",this.resolve)},drop:function(){return this._constraints=[],this},constrain:function(b,c,d){var e;return b&&c?(this._constraints.push(e={id:a.util.uniqueId("rigid-constraint"),bodyA:b,bodyB:c,targetLength:d||this.options.targetLength}),e):!1},remove:function(b){var c,d=this._constraints;if("number"==typeof b)return d.splice(b,1),this;c=a.util.isObject(b);for(var e=0,f=d.length;f>e;++e)if(c&&d[e]===b||!c&&d[e].id===b)return d.splice(e,1),this;return this},resolve:function(){for(var b,c,d,e,f=this._constraints,g=a.scratchpad(),h=g.vector(),i=g.vector(),j=0,k=f.length;k>j;++j)b=f[j],h.clone(b.bodyA.state.pos),i.clone(b.bodyB.state.pos).vsub(h),c=i.norm(),d=(c-b.targetLength)/c,i.mult(d),e=b.bodyB.mass/(b.bodyA.mass+b.bodyB.mass),b.bodyA.fixed||(i.mult(e),b.bodyA.state.pos.vadd(i),i.mult(1/e)),b.bodyB.fixed||(i.mult(1-e),b.bodyB.state.pos.vsub(i));g.done()},getConstraints:function(){return[].concat(this._constraints)}}}),a.behavior("sweep-prune",function(b){function c(a,b){return a===b?!1:a>b?a<<16|65535&b:b<<16|65535&a}var d="collisions:candidates",e=1,f=function(){return e++},g={x:0,y:1};return{init:function(a){b.init.call(this,a),this.clear()},clear:function(){this.tracked=[],this.pairs=[],this.intervalLists={};for(var a in g)this.intervalLists[a]=[]},connect:function(a){a.subscribe("add:body",this.trackBody,this),a.subscribe("remove:body",this.untrackBody,this),a.subscribe("integrate:velocities",this.sweep,this);for(var b=a.getBodies(),c=0,d=b.length;d>c;++c)this.trackBody({body:b[c]})},disconnect:function(a){a.unsubscribe("add:body",this.trackBody),a.unsubscribe("remove:body",this.untrackBody),a.unsubscribe("integrate:velocities",this.sweep),this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this.checkOverlaps()},sortIntervalLists:function(){var a,b,c,d,e,f,h,i,j;for(var k in g)for(a=this.intervalLists[k],c=0,b=a.length,j=g[k];++c<b;){for(e=a[c],f=e.val.get(j),d=c,h=a[d-1],i=h&&h.val.get(j);d>0&&(i>f||i===f&&h.type&&!e.type);)a[d]=h,d--,h=a[d-1],i=h&&h.val.get(j);a[d]=e}},getPair:function(a,b,d){var e=c(a.id,b.id);if(e===!1)return null;var f=this.pairs[e];if(!f){if(!d)return null;f=this.pairs[e]={bodyA:a.body,bodyB:b.body,flag:0}}return f},checkOverlaps:function(){var a,b,c,d,e,f,h,i,j,k=g.z||g.y||g.x,l=[],m=0,n=[];for(var o in g)for(a="x"===o,e=this.intervalLists[o],h=-1,f=e.length;++h<f;)if(d=e[h],b=d.tracker,d.type)for(i=m;--i>=0;)c=l[i],c===b?(m-1>i?l[i]=l.pop():l.pop(),m--):(j=this.getPair(b,c,a),j&&(j.flag=a?0:j.flag+1,j.flag===k&&n.push(j)));else m=l.push(b);return n},updateIntervals:function(){for(var b,c,d=a.scratchpad(),e=d.vector(),f=d.vector(),g=this.tracked,h=g.length;--h>=0;)b=g[h],c=b.interval,e.clone(b.body.state.pos),f.clone(b.body.aabb()),c.min.val.clone(e).vsub(f),c.max.val.clone(e).vadd(f);d.done()},trackBody:function(b){var c=b.body,d={id:f(),body:c},e={min:{type:!1,val:a.vector(),tracker:d},max:{type:!0,val:a.vector(),tracker:d}};d.interval=e,this.tracked.push(d);for(var h in g)this.intervalLists[h].push(e.min,e.max)},untrackBody:function(a){for(var b,c,d,e,f=a.body,h=this.tracked,i=0,j=h.length;j>i;++i)if(d=h[i],d.body===f){h.splice(i,1);for(var k in g){e=0,b=this.intervalLists[k];for(var l=0,m=b.length;m>l;++l)if(c=b[l],c===d.interval.min||c===d.interval.max){if(b.splice(l,1),l--,j--,e>0)break;e++}}break}},sweep:function(a){var b,c=this;a.bodies,a.dt,b=c.broadPhase(),b.length&&this._world.publish({topic:d,candidates:b})}}}),a.behavior("verlet-constraints",function(b){var c=2*Math.PI,d={iterations:2};return{init:function(c){b.init.call(this,c),a.util.extend(this.options,d,c),this._distanceConstraints=[],this._angleConstraints=[]},connect:function(a){var b=a.integrator();if(b&&b.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';a.subscribe("integrate:positions",this.resolve,this)},disconnect:function(a){a.unsubscribe("integrate:positions",this.resolve)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(b,c,d,e){var f;return b&&c?(f={id:a.util.uniqueId("dis-constraint"),type:"dis",bodyA:b,bodyB:c,stiffness:d||.5,targetLength:e||c.state.pos.dist(b.state.pos)},f.targetLengthSq=f.targetLength*f.targetLength,this._distanceConstraints.push(f),f):!1},angleConstraint:function(b,c,d,e,f){var g;return b&&c?(g={id:a.util.uniqueId("ang-constraint"),type:"ang",bodyA:b,bodyB:c,bodyC:d,stiffness:e||.5,targetAngle:f||c.state.pos.angle2(b.state.pos,d.state.pos)},this._angleConstraints.push(g),g):!1},remove:function(b){var c,d,e,f,g;if(e=a.util.isObject(b),d=e?b.type:b.substr(0,3),c="ang"===d?this._angleConstraints:this._distanceConstraints,e){for(f=0,g=c.length;g>f;++f)if(c[f]===b)return c.splice(f,1),this}else for(f=0,g=c.length;g>f;++f)if(c[f].id===b)return c.splice(f,1),this;return this},resolveAngleConstraints:function(b){for(var d,e,f,g,h=this._angleConstraints,i=a.scratchpad(),j=i.transform(),k=0,l=h.length;l>k;++k)d=h[k],e=d.bodyB.state.pos.angle2(d.bodyA.state.pos,d.bodyC.state.pos),f=e-d.targetAngle,f&&(f<=-Math.PI?f+=c:f>=Math.PI&&(f-=c),j.setTranslation(d.bodyB.state.pos),f*=-b*d.stiffness,d.bodyA.fixed||d.bodyB.fixed||d.bodyC.fixed||(g=1/(d.bodyA.mass+d.bodyB.mass+d.bodyC.mass)),d.bodyA.fixed||(e=d.bodyB.fixed||d.bodyC.fixed?d.bodyB.fixed?f*d.bodyC.mass/(d.bodyC.mass+d.bodyA.mass):f*d.bodyB.mass/(d.bodyB.mass+d.bodyA.mass):f*(d.bodyB.mass+d.bodyC.mass)*g,j.setRotation(e),d.bodyA.state.pos.translateInv(j),d.bodyA.state.pos.rotate(j),d.bodyA.state.pos.translate(j)),d.bodyC.fixed||(e=d.bodyA.fixed||d.bodyB.fixed?d.bodyB.fixed?-f*d.bodyA.mass/(d.bodyC.mass+d.bodyA.mass):-f*d.bodyB.mass/(d.bodyB.mass+d.bodyC.mass):-f*(d.bodyB.mass+d.bodyA.mass)*g,j.setRotation(e),d.bodyC.state.pos.translateInv(j),d.bodyC.state.pos.rotate(j),d.bodyC.state.pos.translate(j)),d.bodyB.fixed||(e=d.bodyA.fixed||d.bodyC.fixed?d.bodyA.fixed?f*d.bodyC.mass/(d.bodyC.mass+d.bodyB.mass):f*d.bodyA.mass/(d.bodyA.mass+d.bodyC.mass):f*(d.bodyA.mass+d.bodyC.mass)*g,j.setRotation(e).setTranslation(d.bodyA.state.pos),d.bodyB.state.pos.translateInv(j),d.bodyB.state.pos.rotate(j),d.bodyB.state.pos.translate(j),j.setTranslation(d.bodyC.state.pos),d.bodyB.state.pos.translateInv(j),d.bodyB.state.pos.rotateInv(j),d.bodyB.state.pos.translate(j)));i.done()},resolveDistanceConstraints:function(b){for(var c,d,e,f,g=this._distanceConstraints,h=a.scratchpad(),i=h.vector(),j=0,k=g.length;k>j;++j)c=g[j],i.clone(c.bodyB.state.pos).vsub(c.bodyA.state.pos),d=i.normSq()||1e-4*Math.random(),e=b*c.stiffness*(d-c.targetLengthSq)/d,i.mult(e),f=c.bodyA.fixed||c.bodyB.fixed?1:c.bodyB.mass/(c.bodyA.mass+c.bodyB.mass),c.bodyA.fixed||(c.bodyB.fixed||i.mult(f),c.bodyA.state.pos.vadd(i),c.bodyB.fixed||i.mult(1/f)),c.bodyB.fixed||(c.bodyA.fixed||i.mult(1-f),c.bodyB.state.pos.vsub(i));h.done()},shuffleConstraints:function(){this._distanceConstraints=a.util.shuffle(this._distanceConstraints),this._angleConstraints=a.util.shuffle(this._angleConstraints)},resolve:function(){for(var a=this.options.iterations,b=1/a,c=0;a>c;c++)this.resolveDistanceConstraints(b),this.resolveAngleConstraints(b)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),a.integrator("improved-euler",function(b){return{init:function(a){b.init.call(this,a)},integrateVelocities:function(a,b){for(var c,d=1-this.options.drag,e=null,f=0,g=a.length;g>f;++f)e=a[f],c=e.state,e.fixed?(c.vel.zero(),c.acc.zero(),c.angular.vel=0,c.angular.acc=0):(c.old.vel.clone(c.vel),c.old.acc.clone(c.acc),c.vel.vadd(c.acc.mult(b)),d&&c.vel.mult(d),c.acc.zero(),c.old.angular.vel=c.angular.vel,c.angular.vel+=c.angular.acc*b,c.angular.acc=0)},integratePositions:function(b,c){for(var d,e=.5*c*c,f=null,g=a.scratchpad(),h=g.vector(),i=0,j=b.length;j>i;++i)f=b[i],d=f.state,f.fixed||(d.old.pos.clone(d.pos),h.clone(d.old.vel),d.pos.vadd(h.mult(c)).vadd(d.old.acc.mult(e)),d.old.acc.zero(),d.old.angular.pos=d.angular.pos,d.angular.pos+=d.old.angular.vel*c+d.old.angular.acc*e,d.old.angular.acc=0);g.done()}}}),a.renderer("canvas",function(b){var c=2*Math.PI,d=function(a,b){var c=document.createElement(a||"div");return b&&(c.innerHTML=b),c},e={debug:!1,metaEl:null,styles:{point:"rgba(80, 50, 100, 0.7)",circle:{strokeStyle:"rgba(70, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(44, 105, 44, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"},"convex-polygon":{strokeStyle:"rgba(80, 50, 100, 0.7)",lineWidth:1,fillStyle:"rgba(114, 105, 124, 0.7)",angleIndicator:"rgba(69, 51, 78, 0.7)"}},offset:{x:0,y:0}},f=function(b,c){return a.util.isPlainObject(c)?a.util.extend({},b,c,f):void 0!==c?c:b};return{init:function(c){if(b.init.call(this,c),this.options=a.util.extend({},e,this.options,f),this.options.offset=a.vector(this.options.offset),this.hiddenCanvas=document.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100,!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var g=this.el;if("CANVAS"!==g.nodeName.toUpperCase()&&(g=document.createElement("canvas"),this.el.appendChild(g),"string"==typeof this.options.el&&this.el===document.body&&(g.id=this.options.el),this.el=g),g.width=this.options.width,g.height=this.options.height,this.ctx=g.getContext("2d"),this.els={},this.options.meta){var h=this.options.metaEl||d();h.className="pjs-meta",this.els.fps=d("span"),this.els.ipf=d("span"),h.appendChild(d("span","fps: ")),h.appendChild(this.els.fps),h.appendChild(d("br")),h.appendChild(d("span","ipf: ")),h.appendChild(this.els.ipf),g.parentNode.insertBefore(h,g)}},setStyle:function(b,c){c=c||this.ctx,a.util.isObject(b)?(c.strokeStyle=b.strokeStyle,c.fillStyle=b.fillStyle,c.lineWidth=b.lineWidth):(c.fillStyle=c.strokeStyle=b,c.lineWidth=1)},drawCircle:function(a,b,d,e,f){f=f||this.ctx,f.beginPath(),this.setStyle(e,f),f.arc(a,b,d,0,c,!1),f.closePath(),f.stroke(),f.fill()},drawPolygon:function(a,b,c){var d=a[0],e=void 0===d.x?d.get(0):d.x,f=void 0===d.y?d.get(1):d.y,g=a.length;c=c||this.ctx,c.beginPath(),this.setStyle(b,c),c.moveTo(e,f);for(var h=1;g>h;++h)d=a[h],e=void 0===d.x?d.get(0):d.x,f=void 0===d.y?d.get(1):d.y,c.lineTo(e,f);g>2&&c.closePath(),c.stroke(),c.fill()},drawLine:function(a,b,c,d){var e=void 0===a.x?a.get(0):a.x,f=void 0===a.y?a.get(1):a.y;d=d||this.ctx,d.beginPath(),this.setStyle(c,d),d.moveTo(e,f),e=void 0===b.x?b.get(0):b.x,f=void 0===b.y?b.get(1):b.y,d.lineTo(e,f),d.stroke(),d.fill()},createView:function(a,b){var c=new Image,d=a.aabb(),e=d.halfWidth+Math.abs(d.pos.x),f=d.halfHeight+Math.abs(d.pos.y),g=e+1,h=f+1,i=this.hiddenCtx,j=this.hiddenCanvas,k=a.name;return b=b||this.options.styles[k],g+=0|b.lineWidth,h+=0|b.lineWidth,j.width=2*e+2+(0|2*b.lineWidth),j.height=2*f+2+(0|2*b.lineWidth),i.save(),i.translate(g,h),"circle"===k?this.drawCircle(0,0,a.radius,b,i):"convex-polygon"===k&&this.drawPolygon(a.vertices,b,i),b.angleIndicator&&(i.beginPath(),this.setStyle(b.angleIndicator,i),i.moveTo(0,0),i.lineTo(e,0),i.closePath(),i.stroke()),i.restore(),c.src=j.toDataURL("image/png"),c.width=j.width,c.height=j.height,c},drawMeta:function(a){this.els.fps.innerHTML=a.fps.toFixed(2),this.els.ipf.innerHTML=a.ipf},beforeRender:function(){this.ctx.clearRect(0,0,this.el.width,this.el.height)},drawBody:function(a,b){var c=this.ctx,d=a.state.pos,e=this.options.offset,f=a.aabb();c.save(),c.translate(d.get(0)+e.get(0),d.get(1)+e.get(1)),c.rotate(a.state.angular.pos),c.drawImage(b,-b.width/2,-b.height/2),c.restore(),this.options.debug&&(c.save(),c.translate(e.get(0),e.get(1)),this.drawPolygon([{x:f.pos.x-f.x,y:f.pos.y-f.y},{x:f.pos.x+f.x,y:f.pos.y-f.y},{x:f.pos.x+f.x,y:f.pos.y+f.y},{x:f.pos.x-f.x,y:f.pos.y+f.y}],"rgba(100, 255, 100, 0.3)"),c.restore())}}}),a.renderer("dom",function(a){var b,c={},d=document.createElement("div"),e=function(a){return a.replace(/(?:^|\s)\w/g,function(a){return a.toUpperCase()})},f=function(a){if(c[a])return c[a];for(var b,f=["Webkit","Moz","Ms","O"],g=0,h=f.length;h>g;++g)if(b=f[g]+e(a),b in d.style)return c[a]=b;return b in d.style?c[a]=a:!1},g="pjs-",h="px",i=f("transform"),j=function(a,b){var c=document.createElement(a||"div");return b&&(c.innerHTML=b),c};return b=i?function(a,b){var c=a.state.pos;b.style[i]="translate("+c.get(0)+"px,"+c.get(1)+"px) rotate("+a.state.angular.pos+"rad)"}:function(a,b){var c=a.state.pos;b.style.left=c.get(0)+h,b.style.top=c.get(1)+h},{init:function(b){a.init.call(this,b);var c=this.el;if(c.style.position="relative",c.style.overflow="hidden",c.style[i]="translateZ(0)",c.style.width=this.options.width+h,c.style.height=this.options.height+h,this.els={},b.meta){var d=j();d.className="pjs-meta",this.els.fps=j("span"),this.els.ipf=j("span"),d.appendChild(j("span","fps: ")),d.appendChild(this.els.fps),d.appendChild(j("br")),d.appendChild(j("span","ipf: ")),d.appendChild(this.els.ipf),c.appendChild(d)}},circleProperties:function(a,b){var c=b.aabb();a.style.width=2*c.halfWidth+h,a.style.height=2*c.halfHeight+h,a.style.marginLeft=-c.halfWidth+h,a.style.marginTop=-c.halfHeight+h},createView:function(a){var b=j(),c=a.name+"Properties";return b.className=g+a.name,b.style.position="absolute",b.style.top="0px",b.style.left="0px",this[c]&&this[c](b,a),this.el.appendChild(b),b},drawMeta:function(a){this.els.fps.innerHTML=a.fps.toFixed(2),this.els.ipf.innerHTML=a.ipf},drawBody:b}}),a});